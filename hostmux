#!/bin/sh

USAGE="hostmux -h | [-xpPa] [-l <tmux layout>] [-s <session name>] [-f <host_file>] host1 [host2 ...]"

SESSION_NAME=hostmux
LAYOUT=even-vertical
CLOSE=
SET_PANE_TITLE=false
SET_PROMPT=false
SYNC_PANES=false

# Get optional user settings
while getopts s:l:f:hxpPa opt; do
    case $opt in
    s)     SESSION_NAME=$OPTARG
           ;;
    l)     LAYOUT=$OPTARG
           ;;
    x)     CLOSE=" && exit"
           ;;
    p)     SET_PANE_TITLE=true
           ;;
    P)     SET_PROMPT=true
           ;;
    a)     SYNC_PANES=true
           ;;
    f)     HOSTS_FILE=$OPTARG
           ;;
    h)     echo $USAGE
           exit 0
           ;;
    '?')   echo "$0: invalid option -$OPTARG" >&2
           echo $USAGE >&2
           exit 1
           ;;
esac done
shift $((OPTIND - 1))

NUMBER_OF_HOSTS=0
NUMBER_OF_HOST_ARGS=$#
HOSTS=""

while [ $NUMBER_OF_HOSTS -lt $NUMBER_OF_HOST_ARGS ]
do
    HOSTS="$HOSTS$1 "
    NUMBER_OF_HOSTS=$(($NUMBER_OF_HOSTS+1))
    shift
done

# Read hosts from the hosts file
if [ -n "$HOSTS_FILE" ]
then
    while read line
    do
        HOSTS="$HOSTS$line "
        NUMBER_OF_HOSTS=$(($NUMBER_OF_HOSTS+1))
    done < hf
fi

echo $HOSTS
echo $NUMBER_OF_HOSTS

# Initialize Session
# If we are already in a tmux session just use the current window
if ! { [ "$TERM" = "screen" ] && [ -n "$TMUX" ]; }
    then tmux -2 new-session -d -s $SESSION_NAME
    else tmux rename-window $SESSION_NAME
fi

# Split as many times as we have hosts and reset
# the layout each time for even distribution
LOOP_INDEX=1

while [ $LOOP_INDEX -lt $NUMBER_OF_HOSTS ]; do
    tmux split-window -h -d
    tmux select-layout $LAYOUT
    LOOP_INDEX=$(($LOOP_INDEX+1))
done

# Check what pane-base-index is configured and use it for addressing
# the panes
PANE_INDEX=$(tmux show-window-options -g -v pane-base-index)

# http://stackoverflow.com/questions/9747952/pane-title-in-tmux
if $SET_PANE_TITLE; then
    tmux set-window-option -g pane-border-status top
    tmux set-window-option -g pane-border-format " #{pane_index} [#{pane_title}] "
fi

# Loop through the panes and take the first argument as a ssh host
# then shift the argument list left, increase the index and go
# into next iteration. Now $1 refers to the next argument passed
# to the script
for host in $HOSTS
do
    tmux send-keys -t $PANE_INDEX " ssh $host $CLOSE" C-m
    if $SET_PROMPT; then
        tmux send-keys -t $PANE_INDEX " export PS1=\"[$host]$ \"" C-m
    fi
    if $SET_PANE_TITLE; then
        tmux send-keys -t $PANE_INDEX " unset PROMPT_COMMAND; printf '\033]2;$host\007'" C-m
    fi
    PANE_INDEX=$(($PANE_INDEX+1))
done

if $SYNC_PANES; then
    tmux set-window-option synchronize-panes on
fi

# Attach to the session
# But only if we are not already in a tmux session
if ! { [ "$TERM" = "screen" ] && [ -n "$TMUX" ]; }
  then tmux -2 attach-session -t $SESSION_NAME
fi
